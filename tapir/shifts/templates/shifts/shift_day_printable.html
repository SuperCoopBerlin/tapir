{% load core %}
{% load i18n %}
{% load utils %}
<style>
    /* Seite / Druck */
    @page {
        size: A4 portrait;
        margin: 8mm;
    }

    @media print {
        html, body {
            width: 210mm;
            height: 297mm;
        }
    }

    /* Schrift & Basis */
    body {
        margin: 0;
        font-family: "Arial Narrow", Arial, sans-serif;
        font-size: 11px;
        color: #000;
    }

    /* Zweispaltiges Layout: jede Kolonne füllt eine Spalte.
       Falls du lieber eine Spalte willst, setze column-count:1; */
    .shift-container {
        width: 100%;
        box-sizing: border-box;
        padding: 6px;
        column-count: 2;
        column-gap: 8mm;
    }

    h1 {
        text-align: center;
        margin: 4px 0 6px 0;
        font-size: 14px;
        break-inside: avoid;
    }

    .shift-block {
        border: 1px solid #000;
        margin: 4px 0;
        padding: 4px;
        page-break-inside: avoid;
        break-inside: avoid-column;
        display: inline-block; /* necessary for columns to place blocks */
        width: 100%;
        box-sizing: border-box;
    }

    .shift-header {
        background-color: #e6e6e6;
        padding: 3px 6px;
        font-weight: bold;
        text-align: center;
        border: 1px solid #000;
        margin-bottom: 6px;
        font-size: 12px;
    }

    /* Kopfzeile für die kurzen Checkbox‑Labels (Legende für A/M/E) */
    .att-controls-header {
        width: 100%;
        display: flex;
        justify-content: flex-end;
        align-items: center;
        font-size: 10px;
        font-weight: bold;
        border-left: 1px solid #000;
        padding: 3px 6px;
        box-sizing: border-box;
        margin-bottom: 6px;
    }

    .att-controls-header div {
        text-align: center;
        width: 20%;
        max-width: 20%;
    }

    .att-controls-header .label-set {
        width: 20%;
        display: flex;
        justify-content: space-around;
        gap: 6px;
        margin-left: auto;
        box-sizing: border-box;
        font-size: 11px;
    }

    .att-controls-header .label-set div {
        width: 33%;
        text-align: center;
    }

    .slots-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    /* Kompakte Slot‑Zeile */
    .slot-row {
        display: flex;
        align-items: center;
        border: 1px solid #000;
        padding: 3px;
        box-sizing: border-box;
        height: 40px;
        page-break-inside: avoid;
        break-inside: avoid-column;
    }

    .slot-index {
        width: 6%;
        min-width: 28px;
        text-align: center;
        font-weight: bold;
        border-right: 1px solid #000;
        padding-right: 6px;
        font-size: 11px;
    }

    .slot-info {
        width: 24%;
        padding-left: 6px;
        border-right: 1px solid #000;
        text-align: left;
        font-size: 11px;
        overflow: hidden;
        /* Erlaube Umbrüche statt Ellipsis */
        white-space: normal;
        word-wrap: break-word;
        hyphens: auto;
        line-height: 1.05;
        max-height: 2.1em; /* maximal 2 Zeilen sichtbar (je ~1.05em Höhe) */
    }

    .member-info {
        width: 46%;
        padding-left: 6px;
        border-right: 1px solid #000;
        text-align: left;
        font-size: 10px;
        overflow: hidden;
        line-height: 1.0;
    }

    .attendance-controls {
        width: 24%;
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding-left: 6px;
        gap: 6px;
    }

    /* Kürzere Checkbox‑Darstellung: nur Kästchen, Labels in Kopfzeile */
    .att-checkbox {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-size: 0; /* versteckt untere Labels */
    }

    .att-checkbox span {
        display: none;
    }

    .att-checkbox input[type="checkbox"] {
        width: 12px;
        height: 12px;
        margin-bottom: 0;
    }

    .small-text {
        font-size: 9.5px;
    }

    /* Legende (kurze Labels) oben auf der Seite, sichtbar beim Drucken */
    .legend {
        font-size: 10px;
        margin: 4px 0 8px 0;
        text-align: right;
        break-inside: avoid;
    }

    .legend span {
        margin-left: 8px;
        font-weight: bold;
    }

    /* Feinheiten für Druck: weniger Tinte */
    .shift-header, .att-controls-header {
        background: #f0f0f0;
    }
</style>
<div class="shift-container">
    <h1>{{ shifts.0.start_time|date:'d.m.y' }}</h1>
    <div class="legend" aria-hidden="true">
        <span>A</span> {% translate 'Attended' %} &nbsp; • &nbsp;
        <span>M</span> {% translate 'Missed' %} &nbsp; • &nbsp;
        <span>E</span> {% translate 'Excused' %}
    </div>
    {% for shift in shifts %}
        <div class="shift-block">
            <div class="shift-header">{{ shift.get_display_name }}</div>
            <!-- Einmalige Kopfzeile für die drei Checkbox-Spalten -->
            <div class="att-controls-header" aria-hidden="true">
                <div style="flex:1"></div>
                <div class="label-set">
                    <div>A</div>
                    <div>M</div>
                    <div>E</div>
                </div>
            </div>
            <div class="slots-list">
                {% for slot in shift.slots.all %}
                    <div class="slot-row">
                        <div class="slot-index">#{{ forloop.counter }}</div>
                        <div class="slot-info" title="{{ slot.name }}">
                            <div style="line-height:1.0;">{{ slot.name }}</div>
                            <div class="small-text" style="line-height:1.0;">
                                {#                                {% if slot.required_capabilities|length > 0 %}#}
                                {#                                    {% translate 'Required qualifications: ' %}{{ slot.get_required_capabilities_display }}#}
                                {#                                {% endif %}#}
                            </div>
                        </div>
                        <div class="member-info">
                            {% with slot.get_valid_attendance as attendance %}
                                {% if attendance %}
                                    <div style="line-height:1.0;
                                                white-space:nowrap;
                                                overflow:hidden;
                                                text-overflow:ellipsis">
                                        {% get_display_name_short attendance.user %}
                                        {% if attendance.user.pronouns %}({{ attendance.user.pronouns }}){% endif %}
                                        #{{ attendance.user.share_owner.id }}
                                    </div>
                                    {% if shift.flexible_time %}
                                        {% if attendance.custom_time %}
                                            <div class="small-text" style="line-height:1.0;">
                                                {% translate "Expected to come at" %} {{ attendance.custom_time|time:"H:i" }}
                                            </div>
                                        {% else %}
                                            <div class="small-text" style="line-height:1.0;">{% translate "Flexible time not specified" %}</div>
                                        {% endif %}
                                    {% endif %}
                                    {% feature_flag_enabled "feature_flags.shifts.shift_partner" as shift_partner_enabled %}
                                    {% if shift_partner_enabled and attendance.user.shift_user_data.shift_partner %}
                                        <div class="small-text" style="line-height:1.0;">
                                            ({% translate "Shift partner: " %}{% get_display_name_short attendance.user.shift_user_data.shift_partner.user %}
                                            #{{ attendance.user.shift_user_data.shift_partner.user.get_member_number }})
                                        </div>
                                    {% endif %}
                                    {% if attendance.state == attendance.State.LOOKING_FOR_STAND_IN %}
                                        <div class="small-text" style="line-height:1.0;">({% translate "Looking for a stand-in" %})</div>
                                    {% endif %}
                                    <div class="small-text" style="line-height:1.0;">
                                        {% if attendance.user.shift_user_data.capabilities|length > 0 %}
                                            {% translate 'Has qualifications: ' %}{{ attendance.user.shift_user_data.get_capabilities_display }}
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endwith %}
                        </div>
                        <div class="attendance-controls" aria-label="attendance controls">
                            <label class="att-checkbox" title="{% translate 'Attended' %}">
                                <input type="checkbox" name="attendance_{{ slot.id }}_attended" />
                                <span>{% translate 'Attended' %}</span>
                            </label>
                            <label class="att-checkbox" title="{% translate 'Missed' %}">
                                <input type="checkbox" name="attendance_{{ slot.id }}_missed" />
                                <span>{% translate 'Missed' %}</span>
                            </label>
                            <label class="att-checkbox" title="{% translate 'Excused' %}">
                                <input type="checkbox" name="attendance_{{ slot.id }}_excused" />
                                <span>{% translate 'Excused' %}</span>
                            </label>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
</div>

{% load django_bootstrap5 %}
{% load static %}
{% load i18n %}
{% load coop %}
{% load core %}
{% load utils %}
{% load django_vite %}
<!DOCTYPE html>
{% get_current_language as LANGUAGE_CODE %}
<html lang="{{ LANGUAGE_CODE }}">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
        {% block title %}
        Tapir
        {% endblock title %}
    </title>
    <link rel="stylesheet" href="{% static 'rizoma-static/libs/bootstrap/5.3.8/bootstrap.min.css' %}">
    <link rel="shortcut icon" type="image/png" href="{% static 'core/favicon.ico' %}" />

    <!-- Override base.css -->
    <link rel="stylesheet" href="{% static 'rizoma-static/css/base.css' %}">
    <script src="{% static 'rizoma-static/js/index.js' %}"></script>

    <!-- jQuery is required by select2, so load it here at the top -->
    <script src="{% static 'core/jQuery/jquery-3.5.1.min.js' %}"></script>
    {% block head %}
    {% endblock head %}
    <script>
        $(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
            $('[data-bs-toggle="tooltip"]').each(function () {
                const tooltip_element = $(this)[0];
                const title = tooltip_element.getAttribute("data-bs-original-title")
                if (title) {
                    tooltip_element.innerHTML += "<span class='material-icons tapir-tooltip-icon'>info</span>";
                    tooltip_element.classList.add("tapir-tooltip-item");
                }
            })
        })
    </script>
    {% javascript_environment_variables %}
    {% vite_hmr_client %}
    {% vite_react_refresh %}
    <script src="{% url 'core:javascript-catalog' %}"></script>
</head>

<body class="{% block body_class %}{% endblock %}">
    <header class="navbar bg-white sticky-top shadow py-2 px-0 px-md-3">
        <div class="container-fluid">
            <a href="/" class="navbar-brand">
                <img alt="SuperCoop Berlin Logo" height=30" src="{% static 'rizoma-static/images/light-logo.svg' %}">
            </a>

            <!-- Don't show the navbar toggler if the user is not authenticated (only login link) -->
            {% if request.user.is_authenticated %}
            <div class="d-flex justify-content-end gap-1">
                <button
                    class="navbar-toggler d-block d-md-none border-0 p-2 shadow-none d-flex align-items-center justify-content-center"
                    type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse"
                    aria-controls="tapirNavbar tapirSidebar" aria-expanded="false" aria-label="Toggle navigation">

                    <span class="material-icons">person</span>
                </button>

                <button
                    class="navbar-toggler d-block d-md-none border-0 p-2 shadow-none d-flex align-items-center justify-content-center"
                    type="button" data-bs-toggle="collapse" data-bs-target=".sidebar-collapse"
                    aria-controls="tapirNavbar tapirSidebar" aria-expanded="false" aria-label="Toggle navigation">

                    <span class="material-icons">menu</span>
                </button>
            </div>
            {% endif %}

            <ul class="navbar-nav desktop-profile-links d-none d-md-flex flex-row gap-4">
                {% if perms.coop.view %}
                <li class="nav-item">
                    <form class="form-inline" method="get" action="{% url 'coop:shareowner_list' %}">
                        <span class="mr-5">
                            <input id="member_search" name="display_name" type="text"
                                aria-label="{% translate 'Use this form to search for members' %}"
                                placeholder="{% translate 'Search Members' %}" class="form-control">
                        </span>
                    </form>
                </li>
                {% endif %}

                {% if request.user.is_authenticated %}
                <li class="nav-item">
                    <a class="nav-link small" href="{% url 'accounts:user_me' %}">{% get_display_name_full request.user
                        %}</a>
                </li>

                <li class="nav-item">
                    <a class="nav-link text-danger" href="{% url 'logout' %}">Logout</a>
                </li>
                {% else %}
                <li class="nav-item">
                    <a class="nav-link text-primary" href="{% url 'login' %}">Login</a>
                </li>
                {% endif %}
            </ul>

            <div class="collapse navbar-collapse" id="tapirNavbar" style="justify-content: flex-end">
                <ul class="navbar-nav">
                    {% feature_flag_enabled "feature_flags.statistics.updated_stats_page_09_23" as is_enabled %}
                    {% if is_enabled %}
                    <div>{% campaign_progress_bar %}</div>
                    {% endif %}
                    {% if perms.coop.view %}
                    <li class="nav-item py-2">
                        <form class="form-inline" method="get" action="{% url 'coop:shareowner_list' %}">
                            <span class="mr-5">
                                <input id="member_search" name="display_name" type="text"
                                    aria-label="{% translate 'Use this form to search for members' %}"
                                    placeholder="{% translate 'Search Members' %}" class="form-control  ">
                            </span>
                        </form>
                    </li>
                    {% endif %}
                    {% if request.user.is_authenticated %}
                    <li class="nav-item">
                        <a class="text-dark nav-link" href="{% url 'accounts:user_me' %}">{% get_display_name_full
                            request.user %}</a>
                    </li>
                    <li class="nav-item">
                        <form method="post" action="{% url 'logout' %}">
                            {% csrf_token %}
                            <a class="text-dark nav-link" href="#" id="logout">Logout</a>
                            <script>
                                document.getElementById("logout").addEventListener("click", (event) => { event.target.parentNode.submit() })
                            </script>
                        </form>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="text-light nav-link" href="{% url 'login' %}">Login</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </header>
    <div class="container-fluid">
        <div class="row d-flex">
            {% if request.user.is_authenticated %}
            <nav id="tapirSidebar" class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse sidebar-collapse">
                <div class="sidebar-sticky">

                    <!-- Pushes the links down so that they don't go under the navbar -->
                    {% block sidebar %}
                    {% sidebar_links %}
                    {% endblock sidebar %}
                </div>
            </nav>
            {% endif %}

            <main role="main"
                class="p-2 p-md-3 p-lg-4 {% if request.user.is_authenticated %}ms-sm-auto col-md-9 col-lg-10{% endif %}">
                {% bootstrap_messages %}
                {% block content %}
                {% endblock content %}
            </main>
        </div>
    </div>
    <button id="open-chat" class="open-zammad-chat"
        style="position: fixed;bottom: 0.5em;right: 0.5em;width: 2em;height: 2em;font-size: 2.5em;border-radius: 0.5em;background: var(--bs-primary);border-color: var(--bs-primary);">ðŸ’¬</button>

    <button id="feedback-form" class="chatclosed"
        style="display:none; position: fixed;bottom: 0.5em;right: 0.5em;width: 2em;height: 2em;font-size: 2.5em;border-radius: 0.5em;background: var(--bs-primary);border-color: var(--bs-primary);">ðŸ’¬</button>
</body>
<script src="{% static 'rizoma-static/libs/bootstrap/5.3.8/bootstrap.bundle.min.js' %}"></script>

<script src="https://help.rizoma.pt/assets/chat/chat-no-jquery.min.js"></script>
<script id="zammad_form_script" src="https://help.rizoma.pt/assets/form/form.js"></script>
<script>
        (function () {
            new ZammadChat({
                title: 'Rizomi here to help you!',
                fontSize: '12px',
                flat: true,
                chatId: 1,
                show: false
            });
            $('#feedback-form').ZammadForm({
                messageTitle: 'Leave a message',
                messageSubmit: 'Submit',
                messageThankYou: "Thank you. We'll get back to you as soon as possible.",
                modal: true
            });
            setTimeout(function () {
                var x = document.getElementById('open-chat');
                if (window.getComputedStyle(x).display === "none") {
                    document.getElementsByClassName('chatclosed')[0].
                        style.display = 'block';
                };
            }, 3000);
        });
</script>

</html>